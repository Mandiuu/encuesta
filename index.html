<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuestas y candidatos: amigos y rivales</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: black;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s ease;
        }
        
        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.95;
        }
        
        .main-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .year-selector {
            display: flex;
            background: #f0f2f5;
            border-radius: 12px;
            padding: 4px;
        }
        
        .year-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            font-size: 1em;
        }
        
        .year-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .year-btn:hover:not(.active) {
            background: rgba(255,255,255,0.5);
        }
        
        .play-btn {
            padding: 12px 24px;
            border: none;
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
        }
        
        .play-btn.playing {
            background: linear-gradient(135deg, #f44336, #e53935);
        }
        
        .month-navigator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #f0f2f5;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover:not(:disabled) {
            background: #e0e0e0;
            transform: scale(1.1);
        }
        
        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .month-display {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            min-width: 150px;
            text-align: center;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin: 20px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .stat-card.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card.primary .stat-label {
            color: rgba(255,255,255,0.9);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-name {
            font-size: 1.1em;
            font-weight: 500;
        }
        
        .timeline-container {
            margin-top: 30px;
            display: none;
        }
        
        .timeline-container.active {
            display: block;
        }
        
        .winner-badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .context-note {
            color: black;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .context-note h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .chart-container {
                height: 350px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>¿Son certeras las encuestas de elecciones?</h1>
            <p class="subtitle">Miremos a la encuesta Cadem</p>
        </div>
        
        <div class="main-card">
            <div class="controls">
                <div class="control-group">
                    <span style="font-weight: 600; color: #555;">Año:</span>
                    <div class="year-selector">
                        <button class="year-btn" onclick="changeYear(2017)">2017</button>
                        <button class="year-btn" onclick="changeYear(2021)">2021</button>
                        <button class="year-btn active" onclick="changeYear(2025)">2025</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <button class="play-btn" onclick="togglePlay()" id="playBtn">
                        <span id="playIcon">▶</span> Play
                    </button>
                </div>
            </div>
            
            <div class="month-navigator" id="monthNav">
                <button class="nav-btn" onclick="navigateMonth(-1)" id="prevBtn">◀</button>
                <div class="month-display" id="currentMonthDisplay">Agosto</div>
                <button class="nav-btn" onclick="navigateMonth(1)" id="nextBtn">▶</button>
            </div>
            
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
            
            <div class="stats-grid" id="statsGrid">
                <!-- Stats cards will be inserted here -->
            </div>
            
            <div class="context-note">
                <h3>📊 Contexto Histórico</h3>
                <p id="contextText">
                    En 2025, la carrera presidencial muestra una competencia cerrada entre tres candidatos principales.
                </p>
            </div>
        </div>
    </div>
    
    <script>
        // Datos completos
        const electionData = {
            2017: {
                months: ['Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre'],
                candidates: {
                    'S. Piñera': {
                        data: [25, 26, 28, 30, 35, 40, 43, 43, 44, 45],
                        color: '#3498db'
                    },
                    'A. Guillier': {
                        data: [17, 17, 16, 14, 12, 15, 18, 19, 23, 23],
                        color: '#e74c3c'
                    },
                    'B. Sánchez': {
                        data: [0, 0, 5, 8, 11, 19, 18, 16, 13, 14],
                        color: '#9b59b6'
                    },
                    'C. Goic': {
                        data: [1, 2, 3, 3, 4, 5, 5, 4, 4, 6],
                        color: '#f39c12'
                    },
                    'J.A. Kast': {
                        data: [0, 0, 2, 3, 3, 4, 4, 4, 6, 6],
                        color: '#2ecc71'
                    },
                    'ME-O': {
                        data: [2, 2, 2, 2, 3, 3, 3, 3, 3, 5],
                        color: '#34495e'
                    }
                },
                electionDate: '19 de noviembre',
                winner: 'S. Piñera'
            },
            2021: {
                months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre'],
                candidates: {
                    'G. Boric': {
                        data: [15, 16, 18, 20, 22, 23, 24, 22, 24, 20, 19],
                        color: '#3498db'
                    },
                    'J.A. Kast': {
                        data: [5, 5, 6, 6, 7, 7, 8, 9, 14, 21, 25],
                        color: '#e74c3c'
                    },
                    'Y. Provoste': {
                        data: [10, 10, 11, 11, 12, 12, 11, 13, 15, 12, 9],
                        color: '#9b59b6'
                    },
                    'S. Sichel': {
                        data: [15, 17, 20, 22, 23, 24, 23, 24, 16, 11, 8],
                        color: '#f39c12'
                    },
                    'F. Parisi': {
                        data: [2, 2, 2, 2, 3, 3, 3, 4, 6, 7, 10],
                        color: '#2ecc71'
                    },
                    'ME-O': {
                        data: [3, 3, 3, 3, 3, 3, 3, 3, 4, 5, 5],
                        color: '#34495e'
                    }
                },
                electionDate: '21 de noviembre',
                winner: 'G. Boric'
            },
            2025: {
                months: ['Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto'],
                candidates: {
                    'J.A. Kast': {
                        data: [10, 13, 13, 17, 18, 27, 28],
                        color: '#e74c3c'
                    },
                    'J. Jara': {
                        data: [2, 2, 4, 7, 8, 29, 26],
                        color: '#9c27b0'
                    },
                    'E. Matthei': {
                        data: [24, 18, 20, 17, 16, 18, 16],
                        color: '#3498db'
                    },
                    'F. Parisi': {
                        data: [2, 3, 2, 6, 5, 8, 12],
                        color: '#2ecc71'
                    },
                    'J. Kaiser': {
                        data: [13, 13, 11, 11, 7, 6, 5],
                        color: '#f39c12'
                    },
                    'C. Tohá': {
                        data: [7, 10, 6, 8, 7, 0, 0],
                        color: '#28E0DA'
                    }
                },
                electionDate: '23 de noviembre'
            }
        };
        
        let currentYear = 2025;
        let currentMonth = 'Agosto';
        let mainChart = null;
        let isPlaying = false;
        let playInterval = null;
        
        function initCharts() {
            updateAll();
        }
        
        function togglePlay() {
            const playBtn = document.getElementById('playBtn');
            const playIcon = document.getElementById('playIcon');
            
            if (isPlaying) {
                // Stop playing
                isPlaying = false;
                clearInterval(playInterval);
                playBtn.classList.remove('playing');
                playBtn.innerHTML = '<span id="playIcon">▶</span> Play';
            } else {
                // Start playing
                isPlaying = true;
                playBtn.classList.add('playing');
                playBtn.innerHTML = '<span id="playIcon">⏸</span> Pausar';
                
                // Reset to first month if at the end
                const months = electionData[currentYear].months;
                if (months.indexOf(currentMonth) === months.length - 1) {
                    currentMonth = months[0];
                    updateAll();
                }
                
                // Start interval
                playInterval = setInterval(() => {
                    const months = electionData[currentYear].months;
                    const currentIndex = months.indexOf(currentMonth);
                    
                    if (currentIndex < months.length - 1) {
                        currentMonth = months[currentIndex + 1];
                        updateAll();
                    } else {
                        // Stop at the end
                        togglePlay();
                    }
                }, 3000); // Change month every 3 seconds for smoother viewing
            }
        }
        
        function changeYear(year) {
            // Stop playing if active
            if (isPlaying) {
                togglePlay();
            }
            
            currentYear = year;
            
            // Update buttons
            document.querySelectorAll('.year-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.textContent) === year) {
                    btn.classList.add('active');
                }
            });
            
            // Set to last available month
            const months = electionData[year].months;
            currentMonth = months[months.length - 1];
            
            // Destroy and recreate chart for year change
            if (mainChart) {
                mainChart.destroy();
                mainChart = null;
            }
            
            updateAll();
        }
        
        function changeView(view) {
            currentView = view;
            
            // Update buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Toggle containers
            if (view === 'line') {
                document.getElementById('monthNav').style.display = 'none';
                document.getElementById('timelineContainer').classList.add('active');
                updateTimelineChart();
            } else {
                document.getElementById('monthNav').style.display = 'flex';
                document.getElementById('timelineContainer').classList.remove('active');
                updateBarChart();
            }
        }
        
        function navigateMonth(direction) {
            const months = electionData[currentYear].months;
            const currentIndex = months.indexOf(currentMonth);
            
            if (direction === -1 && currentIndex > 0) {
                currentMonth = months[currentIndex - 1];
                updateAll();
            } else if (direction === 1 && currentIndex < months.length - 1) {
                currentMonth = months[currentIndex + 1];
                updateAll();
            }
        }
        
        function updateAll() {
            updateMonthDisplay();
            updateNavigationButtons();
            updateBarChart();
            updateStats();
            updateContext();
        }
        
        function updateMonthDisplay() {
            document.getElementById('currentMonthDisplay').textContent = currentMonth;
        }
        
        function updateNavigationButtons() {
            const months = electionData[currentYear].months;
            const currentIndex = months.indexOf(currentMonth);
            
            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = currentIndex === months.length - 1;
        }
        
        function updateBarChart() {
            const yearData = electionData[currentYear];
            const monthIndex = yearData.months.indexOf(currentMonth);
            
            // Prepare data
            const labels = [];
            const data = [];
            const colors = [];
            
            Object.entries(yearData.candidates).forEach(([name, candidate]) => {
                if (candidate.data[monthIndex] > 0) {
                    labels.push(name);
                    data.push(candidate.data[monthIndex]);
                    colors.push(candidate.color);
                }
            });
            
            // Sort by value
            const sorted = labels.map((label, i) => ({
                label: label,
                value: data[i],
                color: colors[i]
            })).sort((a, b) => b.value - a.value);
            
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            // Custom plugin to draw "Ganó la elección" text
            const winnerPlugin = {
                id: 'winnerLabel',
                afterDatasetsDraw: function(chart) {
                    if (currentYear === 2025) return; // No winner yet in 2025
                    
                    const ctx = chart.ctx;
                    const winner = electionData[currentYear].winner;
                    const dataset = chart.data.datasets[0];
                    const meta = chart.getDatasetMeta(0);
                    
                    meta.data.forEach((bar, index) => {
                        if (chart.data.labels[index] === winner) {
                            ctx.save();
                            ctx.font = 'bold 12px Roboto';
                            ctx.fillStyle = '#00000';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';
                            ctx.fillText('Ganó la elección', bar.x, bar.y - 5);
                            ctx.restore();
                        }
                    });
                }
            };
            
            if (mainChart) {
                // Update existing chart for smooth animation
                mainChart.data.labels = sorted.map(item => item.label);
                mainChart.data.datasets[0].data = sorted.map(item => item.value);
                mainChart.data.datasets[0].backgroundColor = sorted.map(item => item.color);
                mainChart.options.plugins.title.text = `Encuesta Cadem - ${currentMonth} ${currentYear}`;
                mainChart.options.scales.y.max = currentYear === 2017 ? 50 : 35;
                mainChart.update('default'); // Smooth animation
            } else {
                mainChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sorted.map(item => item.label),
                        datasets: [{
                            label: 'Intención de voto %',
                            data: sorted.map(item => item.value),
                            backgroundColor: sorted.map(item => item.color),
                            borderWidth: 0,
                            borderRadius: 10
                        }]
                    },
                    plugins: [winnerPlugin],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1200,
                            easing: 'easeInOutQuart'
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.parsed.y + '%';
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: `Encuesta Cadem - ${currentMonth} ${currentYear}`,
                                font: {
                                    size: 20,
                                    weight: 'bold',
                                    family: 'Roboto'
                                },
                                color: '#2c3e50',
                                padding: {
                                    bottom: 30
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: currentYear === 2017 ? 50 : 35,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    },
                                    font: {
                                        family: 'Roboto'
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 16,
                                        family: 'Roboto'
                                    }
                                }
                            }
                        },
                        transitions: {
                            active: {
                                animation: {
                                    duration: 1200
                                }
                            }
                        }
                    }
                });
            }
        }
        
        function updateTimelineChart() {
            const yearData = electionData[currentYear];
            const monthIndex = yearData.months.indexOf(currentMonth);
            
            // Prepare datasets
            const datasets = Object.entries(yearData.candidates).map(([name, candidate]) => ({
                label: name,
                data: candidate.data.slice(0, monthIndex + 1),
                borderColor: candidate.color,
                backgroundColor: candidate.color + '20',
                tension: 0.4,
                borderWidth: 3
            }));
            
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (timelineChart) {
                timelineChart.destroy();
            }
            
            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: yearData.months.slice(0, monthIndex + 1),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: `Evolución Temporal - ${currentYear}`,
                            font: {
                                size: 20,
                                weight: 'bold',
                                family: 'Roboto'
                            },
                            color: '#2c3e50',
                            padding: {
                                bottom: 30
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: currentYear === 2017 ? 50 : 35,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: {
                                    family: 'Roboto'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Roboto'
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateStats() {
            const yearData = electionData[currentYear];
            const monthIndex = yearData.months.indexOf(currentMonth);
            
            // Get top 3
            const candidates = [];
            Object.entries(yearData.candidates).forEach(([name, candidate]) => {
                if (candidate.data[monthIndex] > 0) {
                    candidates.push({
                        name: name,
                        value: candidate.data[monthIndex],
                        color: candidate.color
                    });
                }
            });
            
            candidates.sort((a, b) => b.value - a.value);
            const top3 = candidates.slice(0, 3);
            
            let statsHTML = '';
            top3.forEach((candidate, index) => {
                const label = index === 0 ? 'LIDERA' : index === 1 ? 'SEGUNDO' : 'TERCERO';
                statsHTML += `
                    <div class="stat-card">
                        <div class="stat-label">${label}</div>
                        <div class="stat-value" style="color: ${candidate.color};">${candidate.value}%</div>
                        <div class="stat-name">${candidate.name}</div>
                    </div>
                `;
            });
            
            
            document.getElementById('statsGrid').innerHTML = statsHTML;
        }
        
        function updateContext() {
            const contexts = {
                2017: 'En 2017, Sebastián Piñera dominó las encuestas durante toda la campaña y ganó con 36.6% en primera vuelta y 54.6% en segunda vuelta contra Alejandro Guillier.',
                2021: 'En 2021, José Antonio Kast pasó del último lugar (5%) en enero al primero en noviembre, pero Gabriel Boric ganó la presidencia en segunda vuelta con 55.9%.',
                2025: 'En 2025, la carrera muestra alta competitividad con tres candidatos principales. Kast lidera actualmente, seguido muy de cerca por Jara, mientras Matthei ha perdido terreno.'
            };
            
            document.getElementById('contextText').textContent = contexts[currentYear];
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', initCharts);
    </script>
</body>
</html>